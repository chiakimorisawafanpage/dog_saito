{% extends "base.html" %}
{% load static %}

{% block title %}Оформление заказа - Dog Fashion{% endblock %}

{% block header %}
    
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom" style="position: relative !important;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/" style="font-family: var(--font-secondary); font-size: 1.5rem; letter-spacing: 1px;">Dog Fashion</a>
            
            
            <div class="ms-auto">
                 <a href="#" class="text-dark text-decoration-none small fw-bold" style="letter-spacing: 0.5px;">ACCOUNT</a>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container" style="margin-top: 60px; padding-bottom: 100px;">
    
    <div class="row g-5">
        
        <div class="col-lg-7">
            
            
            
            
            <div class="mb-5">
                <h4 class="text-uppercase mb-4 fw-normal" style="font-family: var(--font-primary); letter-spacing: 1px; font-size: 1.2rem;">Контакты</h4>
                <form action="." method="post" id="order-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ form.email }}
                    </div>
                    
                    
                    <h4 class="text-uppercase mb-4 mt-5 fw-normal" style="font-family: var(--font-primary); letter-spacing: 1px; font-size: 1.2rem;">Доставка</h4>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.first_name }}
                        </div>
                        <div class="col-md-6">
                            {{ form.last_name }}
                        </div>
                        <div class="col-12">
                            <div class="form-floating mb-0">
                                
                                <input type="text" class="form-control rounded-0" id="country" placeholder="Страна" value="Россия" readonly>
                                <label for="country">Страна</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {{ form.city }}
                        </div>
                        <div class="col-md-6">
                            {{ form.postal_code }}
                        </div>
                        <div class="col-12">
                            {{ form.address }}
                        </div>
                        
                        
                        <div class="col-12">
                            <input type="tel" name="phone" class="form-control rounded-0" placeholder="Телефон">
                        </div>
                    </div>

                    
                    <h4 class="text-uppercase mb-4 mt-5 fw-normal" style="font-family: var(--font-primary); letter-spacing: 1px; font-size: 1.2rem;">Оплата</h4>
                    
                    <div class="mb-4">
                        
                        <div class="d-flex border-bottom mb-3">
                            <label class="pb-2 me-4 cursor-pointer border-bottom border-2 border-dark fw-bold payment-tab" data-target="card-payment">
                                <input type="radio" name="payment_method" value="card" class="d-none" checked>
                                Банковская карта
                            </label>
                            <label class="pb-2 cursor-pointer payment-tab text-muted" data-target="sbp-payment">
                                <input type="radio" name="payment_method" value="sbp" class="d-none">
                                СБП / QR
                            </label>
                        </div>

                        
                        <div id="card-payment" class="payment-content">
                            <div class="row g-3">
                                <div class="col-12">
                                    <input type="text" class="form-control rounded-0" placeholder="Номер карты" id="card-number" maxlength="19">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control rounded-0" placeholder="MM / YY" id="card-expiry" maxlength="7">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control rounded-0" placeholder="CVC" id="card-cvc" maxlength="3">
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control rounded-0" placeholder="Владелец карты (как на карте)">
                                </div>
                            </div>
                            <div class="mt-3 small text-muted d-flex align-items-center">
                                <i class="fa-solid fa-lock me-2"></i> Данные защищены шифрованием SSL
                            </div>
                        </div>

                        
                        <div id="sbp-payment" class="payment-content d-none text-center py-4 bg-light">
                             <div class="mb-3">
                                 <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SimulatedPayment-{{ cart.get_final_price }}" alt="QR Code" class="img-fluid border p-2 bg-white">
                             </div>
                             <p class="mb-2 small">Отсканируйте QR-код приложением банка</p>
                             <p class="mb-0 fw-bold">{{ cart.get_final_price }} ₽</p>
                        </div>
                    </div>

                    <div class="mt-5">
                        <button type="submit" class="btn btn-dark btn-lg w-100 text-uppercase py-3 rounded-0" style="letter-spacing: 2px; font-size: 0.9rem;">
                            Оплатить заказ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        
        <div class="col-lg-5">
            <div class="bg-light p-4 sticky-top" style="top: 100px;">
                
                
                
                <div class="mb-4 border-bottom">
                    {% for item in cart %}
                    <div class="d-flex gap-3 mb-3 align-items-center">
                        <div class="position-relative" style="width: 70px; height: 70px;">
                            <img src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% endif %}" alt="{{ item.product.name }}" class="w-100 h-100 object-fit-cover border">
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary opacity-75" style="font-size: 0.6rem;">
                                {{ item.quantity }}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 small text-uppercase fw-bold" style="letter-spacing: 0.5px;">{{ item.product.name }}</h6>
                            {% if item.size %}
                            <small class="text-muted" style="font-size: 0.75rem;">Размер: {{ item.size }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <p class="mb-0 small">{{ item.total_price }} ₽</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                
                <div class="mb-4 d-flex gap-2">
                    <input type="text" class="form-control rounded-0 shadow-none" placeholder="Промокод" style="font-size: 0.9rem;">
                    <button class="btn btn-dark rounded-0 shadow-none" style="font-size: 0.9rem;">Применить</button>
                </div>

                
                <div class="border-top pt-3">
                    <div class="d-flex justify-content-between mb-2 small text-muted">
                        <span>Сумма заказа</span>
                        <span>{{ cart.get_total_price }} ₽</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small text-muted">
                        <span>Доставка</span>
                        <span>
                            {% if cart.get_shipping_cost > 0 %}
                                {{ cart.get_shipping_cost }} ₽
                            {% else %}
                                Бесплатно
                            {% endif %}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-3 mt-2 align-items-end">
                        <span class="text-uppercase small fw-bold" style="letter-spacing: 1px;">Итого</span>
                        <div>
                             <span class="text-muted small me-2">RUB</span>
                             <strong class="fs-4 fw-normal">{{ cart.get_final_price }} ₽</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.payment-tab');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Visual toggle
                tabs.forEach(t => {
                    t.classList.remove('border-bottom', 'border-2', 'border-dark', 'fw-bold');
                    t.classList.add('text-muted');
                });
                this.classList.remove('text-muted');
                this.classList.add('border-bottom', 'border-2', 'border-dark', 'fw-bold');

                // Content toggle
                const targetId = this.dataset.target;
                document.querySelectorAll('.payment-content').forEach(content => {
                    content.classList.add('d-none');
                });
                document.getElementById(targetId).classList.remove('d-none');
                
                // Check radio
                this.querySelector('input').checked = true;
            });
        });

        // Card Formatting
        const cardNum = document.getElementById('card-number');
        if (cardNum) {
            cardNum.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.substring(0, 16);
                value = value.replace(/(.{4})/g, '$1 ').trim();
                e.target.value = value;
            });
        }

        const cardExpiry = document.getElementById('card-expiry');
        if (cardExpiry) {
            cardExpiry.addEventListener('input', function(e) {
                 let value = e.target.value.replace(/\D/g, '');
                 if (value.length >= 2) {
                     value = value.substring(0, 2) + ' / ' + value.substring(2, 4);
                 }
                 e.target.value = value;
            });
        }
    });
</script>
{% endblock %}
