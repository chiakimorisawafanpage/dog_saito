{% extends "base.html" %}
{% load static %}

{% block title %}Корзина{% endblock %}

{% block content %}
{% with msg_list=messages|slice:":100" %}
<div class="container py-5" style="margin-top: 80px; min-height: 60vh;">
    <h1 class="text-center mb-5" style="font-family: 'Playfair Display', serif; letter-spacing: 2px;">ТВОЯ КОРЗИНА</h1>

    {% if cart|length == 0 %}
        
        <div class="text-center mb-5">
            <p class="text-muted" style="font-size: 1.2rem;">Здесь пока ничего нет</p>
        </div>
    {% else %}
        
        <div class="row mb-5">
            <div class="col-lg-12">
                
                <div class="border-bottom border-dark mb-4"></div>

                {% for item in cart %}
                    {% with product=item.product %}
                    <div class="row align-items-center mb-4 cart-item">
                        
                        <div class="col-md-2 col-4">
                            <div class="bg-light position-relative overflow-hidden" style="padding-top: 100%;">
                                <a href="{% url 'products:product_detail' product.slug %}" class="text-decoration-none">
                                    {% if product.images.exists %}
                                        <img src="{{ product.images.first.image.url }}" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover" alt="{{ product.name }}">
                                    {% else %}
                                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-muted">No Img</div>
                                    {% endif %}
                                </a>
                            </div>
                        </div>

                        
                        <div class="col-md-4 col-8">
                            <h5 class="fw-bold text-uppercase mb-1">
                                <a href="{% url 'products:product_detail' product.slug %}" class="text-dark text-decoration-none">{{ product.name }}</a>
                            </h5>
                            <p class="text-muted mb-1">Цена: {{ item.price }} ₽</p>
                            {% if item.size %}
                                <p class="text-muted mb-0">Размер: {{ item.size }}</p>
                            {% endif %}
                        </div>

                        
                        <div class="col-md-3 col-6 mt-3 mt-md-0 d-flex align-items-center gap-3">
                            <div class="position-relative error-container-{{ item.unique_id }}">
                                
                                <form action="{% url 'cart:cart_update' product.id %}" method="post" class="d-flex align-items-center cart-update-form" data-unique-id="{{ item.unique_id }}">
                                    {% csrf_token %}
                                    {% if item.size %}<input type="hidden" name="size" value="{{ item.size }}">{% endif %}
                                    
                                    <div class="input-group input-group-sm" style="width: 100px;">
                                        <button type="submit" name="quantity" value="{{ item.quantity|add:'-1' }}" class="btn btn-outline-dark quantity-btn" {% if item.quantity <= 1 %}disabled{% endif %}>-</button>
                                        <input type="text" class="form-control text-center border-dark quantity-input" value="{{ item.quantity }}" readonly>
                                        <button type="submit" name="quantity" value="{{ item.quantity|add:'1' }}" class="btn btn-outline-dark quantity-btn">+</button>
                                    </div>
                                </form>

                                
                                {% for msg in msg_list %}
                                    {% if item.unique_id in msg.extra_tags %}
                                        <div class="stock-error-msg text-danger position-absolute start-0 top-100 mt-1 text-nowrap" style="font-size: 0.65rem; letter-spacing: 0.5px; opacity: 1; transition: opacity 0.5s ease;">
                                            {{ msg }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            
                            <form action="{% url 'cart:cart_remove' product.id %}" method="post">
                                {% csrf_token %}
                                {% if item.size %}<input type="hidden" name="size" value="{{ item.size }}">{% endif %}
                                <button type="submit" class="btn btn-link text-dark p-0 text-decoration-none"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        </div>

                        
                        <div class="col-md-3 col-6 mt-3 mt-md-0 text-end">
                            <p class="fw-bold mb-0 item-total-price" id="item-total-{{ item.unique_id }}">{{ item.total_price }} ₽</p>
                        </div>
                    </div>
                    <div class="border-bottom border-light mb-4"></div>
                    {% endwith %}
                {% endfor %}

                
                <div class="row justify-content-end mt-4">
                    <div class="col-md-4 text-end">
                        <p class="text-muted text-uppercase small mb-2">Финальная цена</p>
                        <h3 class="fw-bold mb-4" id="cart-total-price">{{ cart.get_total_price }} ₽</h3>
                        <a href="{% url 'orders:order_create' %}" class="btn btn-dark w-100 py-3 text-uppercase rounded-0" style="letter-spacing: 1px;">Перейти к оплате</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    
    <div class="mt-5 pt-5 border-top">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="text-uppercase text-muted mb-0" style="letter-spacing: 1px; font-size: 0.9rem;">Potrebbero interessarti</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-dark rounded-circle recommended-prev" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&larr;</button>
                <button class="btn btn-sm btn-outline-dark rounded-circle recommended-next" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&rarr;</button>
           </div>
        </div>

        <div class="swiper recommendedSwiper">
            <div class="swiper-wrapper">
                {% for product in recommended_products %}
                <div class="swiper-slide">
                    <div class="product-card h-100">
                        <div class="bg-light mb-2 position-relative overflow-hidden" style="padding-top: 125%;">
                             <a href="{% url 'products:product_detail' product.slug %}" class="text-decoration-none stretched-link"> 
                                {% if product.images.exists %}
                                    <img src="{{ product.images.first.image.url }}" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover" alt="{{ product.name }}">
                                {% else %}
                                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-muted bg-light">No Image</div>
                                {% endif %}
                            </a>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-start">
                             <div>
                                <h6 class="font-primary text-uppercase mb-1" style="font-size: 0.85rem; letter-spacing: 0.5px;">{{ product.name }}</h6>
                             </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="text-muted" style="font-size: 0.9rem;">Prezzo di listino <br> {{ product.price }} ₽</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    
    
</div>
{% endwith %}
{% endblock %}

{% block scripts %}
<script>
    var recommendedSwiper = new Swiper(".recommendedSwiper", {
        slidesPerView: 2, // Mobile default
        spaceBetween: 20,
        loop: true, // Infinite loop
        navigation: {
            nextEl: ".recommended-next",
            prevEl: ".recommended-prev",
        },
        breakpoints: {
            640: { slidesPerView: 2, spaceBetween: 20 }, 
            768: { slidesPerView: 3, spaceBetween: 30 },
            1024: { slidesPerView: 4, spaceBetween: 40 }, // Desktop: 4 items
        }
    });

    // AJAX Cart Update
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quantity-btn')) {
            e.preventDefault();
            const btn = e.target;
            const form = btn.closest('form');
            const url = form.action;
            const formData = new FormData(form);
            
            // Add the button's value to formData because submit buttons aren't included automatically when not submitting
            formData.append('quantity', btn.value);
            
            const uniqueId = form.getAttribute('data-unique-id');
            const errorContainer = document.querySelector(`.error-container-${uniqueId}`);
            
            // Optional: disable buttons while processing
            const btns = form.querySelectorAll('button');
            btns.forEach(b => b.disabled = true);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update Quantity Input
                    form.querySelector('.quantity-input').value = data.quantity;
                    
                    // Update Item Total
                    const itemTotal = document.getElementById(`item-total-${uniqueId}`);
                    if (itemTotal) itemTotal.textContent = data.item_total;
                    
                    // Update Cart Total
                    const cartTotal = document.getElementById('cart-total-price');
                    if (cartTotal) cartTotal.textContent = data.cart_total;
                    
                    // Update Navbar Badge
                    const badge = document.getElementById('cart-badge');
                    if (badge) badge.textContent = data.cart_count;
                    
                    // Update buttons value for next click
                    const minusBtn = form.querySelector('button[value]'); // assumes first one is minus? No, value attribute is static in HTML
                    // Actually, we need to update the values of the buttons based on new quantity
                    const inputQty = parseInt(data.quantity);
                    const minus = form.querySelector('button:first-child');
                    const plus = form.querySelector('button:last-child');
                    
                    if (minus) {
                         minus.value = inputQty - 1;
                         minus.disabled = (inputQty <= 1);
                    }
                    if (plus) plus.value = inputQty + 1;
                    
                    // Remove any existing errors
                     const existingError = errorContainer.querySelector('.stock-error-msg');
                     if (existingError) existingError.remove();

                } else {
                    // Show Error
                    if (data.error) {
                        // Remove old
                        const existingError = errorContainer.querySelector('.stock-error-msg');
                        if (existingError) existingError.remove();
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'stock-error-msg text-danger position-absolute start-0 top-100 mt-1 text-nowrap';
                        errorDiv.style.cssText = 'font-size: 0.65rem; letter-spacing: 0.5px; opacity: 1; transition: opacity 0.5s ease;';
                        errorDiv.textContent = data.error;
                        
                        errorContainer.appendChild(errorDiv);
                        
                        // Auto fade out
                        setTimeout(() => {
                            errorDiv.style.opacity = '0';
                            setTimeout(() => errorDiv.remove(), 500);
                        }, 5000);
                    }
                }
            })
            .catch(err => console.error('Cart update error:', err))
            .finally(() => {
                // Re-enable buttons
                btns.forEach(b => {
                    // Keep minus disabled if qty is 1
                    if (b.textContent === '-' && form.querySelector('.quantity-input').value <= 1) {
                        b.disabled = true;
                    } else {
                        b.disabled = false;
                    }
                });
            });
        }
    });

    // Auto-hide stock error messages (server-side rendered ones)
    document.addEventListener('DOMContentLoaded', function() {
        const errorMsgs = document.querySelectorAll('.stock-error-msg');
        if (errorMsgs.length > 0) {
            setTimeout(function() {
                errorMsgs.forEach(function(msg) {
                    msg.style.opacity = '0';
                    setTimeout(function() {
                        msg.remove();
                    }, 500); // Wait for transition to finish before removing
                });
            }, 5000); // 5 seconds delay
        }
    });
</script>
{% endblock %}
